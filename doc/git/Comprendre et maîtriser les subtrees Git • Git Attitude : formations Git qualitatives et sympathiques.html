<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!-->
<html class="js video no-maskImage placeholder" lang="en"><!--<![endif]--><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <title>Comprendre et maîtriser les subtrees Git • Git Attitude&nbsp;: formations Git qualitatives et sympathiques</title>
  <meta name="author" content="Christophe Porteneuve">

  
  <meta name="description" content="Enfin, les meilleures pratiques autour des subtrees Git, démos et manips à l'appui&nbsp;! Workflows, commandes, options et réglages.">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

  
  <link rel="canonical" href="http://www.git-attitude.fr/2015/01/30/git-subtrees/">
  <link href="http://www.git-attitude.fr/favicon.ico" rel="icon">
  <link href="Comprendre%20et%20ma%C3%AEtriser%20les%20subtrees%20Git%20%E2%80%A2%20Git%20Attitude%C2%A0:%20formations%20Git%20qualitatives%20et%20sympathiques_fichiers/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="Comprendre%20et%20ma%C3%AEtriser%20les%20subtrees%20Git%20%E2%80%A2%20Git%20Attitude%C2%A0:%20formations%20Git%20qualitatives%20et%20sympathiques_fichiers/widgets.js" id="twitter-wjs"></script><script async="" src="Comprendre%20et%20ma%C3%AEtriser%20les%20subtrees%20Git%20%E2%80%A2%20Git%20Attitude%C2%A0:%20formations%20Git%20qualitatives%20et%20sympathiques_fichiers/cbgapi.loaded_1"></script><script async="" src="Comprendre%20et%20ma%C3%AEtriser%20les%20subtrees%20Git%20%E2%80%A2%20Git%20Attitude%C2%A0:%20formations%20Git%20qualitatives%20et%20sympathiques_fichiers/cbgapi.loaded_0"></script><script gapi_processed="true" src="Comprendre%20et%20ma%C3%AEtriser%20les%20subtrees%20Git%20%E2%80%A2%20Git%20Attitude%C2%A0:%20formations%20Git%20qualitatives%20et%20sympathiques_fichiers/plusone.js" async="" type="text/javascript"></script><script src="Comprendre%20et%20ma%C3%AEtriser%20les%20subtrees%20Git%20%E2%80%A2%20Git%20Attitude%C2%A0:%20formations%20Git%20qualitatives%20et%20sympathiques_fichiers/all.js" id="facebook-jssdk"></script><script src="Comprendre%20et%20ma%C3%AEtriser%20les%20subtrees%20Git%20%E2%80%A2%20Git%20Attitude%C2%A0:%20formations%20Git%20qualitatives%20et%20sympathiques_fichiers/ga.js" async="" type="text/javascript"></script><script src="Comprendre%20et%20ma%C3%AEtriser%20les%20subtrees%20Git%20%E2%80%A2%20Git%20Attitude%C2%A0:%20formations%20Git%20qualitatives%20et%20sympathiques_fichiers/modernizr-2.js"></script>
  <script src="Comprendre%20et%20ma%C3%AEtriser%20les%20subtrees%20Git%20%E2%80%A2%20Git%20Attitude%C2%A0:%20formations%20Git%20qualitatives%20et%20sympathiques_fichiers/ender.js"></script>
  <script src="Comprendre%20et%20ma%C3%AEtriser%20les%20subtrees%20Git%20%E2%80%A2%20Git%20Attitude%C2%A0:%20formations%20Git%20qualitatives%20et%20sympathiques_fichiers/octopress.js" type="text/javascript"></script>
  <script src="Comprendre%20et%20ma%C3%AEtriser%20les%20subtrees%20Git%20%E2%80%A2%20Git%20Attitude%C2%A0:%20formations%20Git%20qualitatives%20et%20sympathiques_fichiers/toc.js" type="text/javascript"></script>
  <link href="http://www.git-attitude.fr/atom.xml" rel="alternate" title="Git Attitude" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="Comprendre%20et%20ma%C3%AEtriser%20les%20subtrees%20Git%20%E2%80%A2%20Git%20Attitude%C2%A0:%20formations%20Git%20qualitatives%20et%20sympathiques_fichiers/css_002.css" rel="stylesheet" type="text/css">
<link href="Comprendre%20et%20ma%C3%AEtriser%20les%20subtrees%20Git%20%E2%80%A2%20Git%20Attitude%C2%A0:%20formations%20Git%20qualitatives%20et%20sympathiques_fichiers/css.css" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-34829944-1']);
    _gaq.push(['_setDomainName', 'git-attitude.fr']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
  <!--
  The following reader engagement measurement script inspired by:
  http://cutroni.com/blog/2012/02/21/advanced-content-tracking-with-google-analytics-part-1/
  http://cutroni.com/blog/2012/02/23/advanced-content-tracking-with-google-analytics-part-2/
  -->
  <script type="text/javascript">
  (function() {
    var debugMode = window.location.hostname !== 'www.git-attitude.fr';

    function track(desc) {
      if (debugMode) {
        // console.log(desc);
      } else {
        _gaq.push(desc);
      }
    }
    
    function setupContentEngagement() {
      var article = $('article[role=article]'), listing = $('#blog-archives');
      if (0 == article.length || listing.length) return;

      // Default time delay before checking location
      var callBackTime = 100;
      // # px before tracking a reader
      var readerLocation = 150;

      var timer = 0, scroller = false, endContent = false, didComplete = false;
      var beginning = Date.now(), totalTime = 0, scrollStart;
      track(['_trackEvent', 'Reading', 'ArticleLoaded', '', , true]);

      function trackLocation() {
        var bottom = $(window).height() + $(window).scrollTop(), height = $(document).height();

        if (bottom > readerLocation && !scroller) {
          scrollStart = Date.now();
          var timeToScroll = Math.round((scrollStart - beginning) / 1000);
          track(['_trackEvent', 'Reading', 'StartReading', '', timeToScroll]);
          scroller = true;
        }

        if (bottom >= article.scrollTop() + article.height() && !endContent) {
          var timeToContentEnd = Math.round((Date.now() - scrollStart) / 1000);
          track(['_trackEvent', 'Reading', 'ContentBottom', '', timeToContentEnd]);
          endContent = true;
        }

        if (bottom >= height && !didComplete) {
          totalTime = Math.round((Date.now() - scrollStart) / 1000);
          if (totalTime < 60) {
            track(['_setCustomVar', 5, 'ReaderType', 'Scanner', 2]);
          } else {
            track(['_setCustomVar', 5, 'ReaderType', 'Reader', 2]);
          }
          track(['_trackEvent', 'Reading', 'PageBottom', '', totalTime]);
          didComplete = true;
        }
      }

      $(window).scroll(function() {
        timer && clearTimeout(timer);
        timer = setTimeout(trackLocation, callBackTime);
      });
    }

    $.domReady(setupContentEngagement);
  })();
  </script>


<script src="Comprendre%20et%20ma%C3%AEtriser%20les%20subtrees%20Git%20%E2%80%A2%20Git%20Attitude%C2%A0:%20formations%20Git%20qualitatives%20et%20sympathiques_fichiers/embed.js" async="" type="text/javascript"></script><script src="Comprendre%20et%20ma%C3%AEtriser%20les%20subtrees%20Git%20%E2%80%A2%20Git%20Attitude%C2%A0:%20formations%20Git%20qualitatives%20et%20sympathiques_fichiers/timeline.js" async="" charset="utf-8" type="text/javascript"></script><script src="Comprendre%20et%20ma%C3%AEtriser%20les%20subtrees%20Git%20%E2%80%A2%20Git%20Attitude%C2%A0:%20formations%20Git%20qualitatives%20et%20sympathiques_fichiers/button.js" async="" charset="utf-8" type="text/javascript"></script><style type="text/css">.fb_hidden{position:absolute;top:-10000px;z-index:10001}.fb_reposition{overflow:hidden;position:relative}.fb_invisible{display:none}.fb_reset{background:none;border:0;border-spacing:0;color:#000;cursor:auto;direction:ltr;font-family:"lucida grande", tahoma, verdana, arial, sans-serif;font-size:11px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:1;margin:0;overflow:visible;padding:0;text-align:left;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;visibility:visible;white-space:normal;word-spacing:normal}.fb_reset>div{overflow:hidden}.fb_link img{border:none}@keyframes fb_transform{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}.fb_animate{animation:fb_transform .3s forwards}
.fb_dialog{background:rgba(82, 82, 82, .7);position:absolute;top:-10000px;z-index:10001}.fb_reset .fb_dialog_legacy{overflow:visible}.fb_dialog_advanced{padding:10px;-moz-border-radius:8px;-webkit-border-radius:8px;border-radius:8px}.fb_dialog_content{background:#fff;color:#333}.fb_dialog_close_icon{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 0 transparent;_background-image:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/yL/r/s816eWC-2sl.gif);cursor:pointer;display:block;height:15px;position:absolute;right:18px;top:17px;width:15px}.fb_dialog_mobile .fb_dialog_close_icon{top:5px;left:5px;right:auto}.fb_dialog_padding{background-color:transparent;position:absolute;width:1px;z-index:-1}.fb_dialog_close_icon:hover{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 -15px transparent;_background-image:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/yL/r/s816eWC-2sl.gif)}.fb_dialog_close_icon:active{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 -30px transparent;_background-image:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/yL/r/s816eWC-2sl.gif)}.fb_dialog_loader{background-color:#f6f7f8;border:1px solid #606060;font-size:24px;padding:20px}.fb_dialog_top_left,.fb_dialog_top_right,.fb_dialog_bottom_left,.fb_dialog_bottom_right{height:10px;width:10px;overflow:hidden;position:absolute}.fb_dialog_top_left{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 0;left:-10px;top:-10px}.fb_dialog_top_right{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 -10px;right:-10px;top:-10px}.fb_dialog_bottom_left{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 -20px;bottom:-10px;left:-10px}.fb_dialog_bottom_right{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 -30px;right:-10px;bottom:-10px}.fb_dialog_vert_left,.fb_dialog_vert_right,.fb_dialog_horiz_top,.fb_dialog_horiz_bottom{position:absolute;background:#525252;filter:alpha(opacity=70);opacity:.7}.fb_dialog_vert_left,.fb_dialog_vert_right{width:10px;height:100%}.fb_dialog_vert_left{margin-left:-10px}.fb_dialog_vert_right{right:0;margin-right:-10px}.fb_dialog_horiz_top,.fb_dialog_horiz_bottom{width:100%;height:10px}.fb_dialog_horiz_top{margin-top:-10px}.fb_dialog_horiz_bottom{bottom:0;margin-bottom:-10px}.fb_dialog_iframe{line-height:0}.fb_dialog_content .dialog_title{background:#6d84b4;border:1px solid #3a5795;color:#fff;font-size:14px;font-weight:bold;margin:0}.fb_dialog_content .dialog_title>span{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/yd/r/Cou7n-nqK52.gif) no-repeat 5px 50%;float:left;padding:5px 0 7px 26px}body.fb_hidden{-webkit-transform:none;height:100%;margin:0;overflow:visible;position:absolute;top:-10000px;left:0;width:100%}.fb_dialog.fb_dialog_mobile.loading{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/ya/r/3rhSv5V8j3o.gif) white no-repeat 50% 50%;min-height:100%;min-width:100%;overflow:hidden;position:absolute;top:0;z-index:10001}.fb_dialog.fb_dialog_mobile.loading.centered{width:auto;height:auto;min-height:initial;min-width:initial;background:none}.fb_dialog.fb_dialog_mobile.loading.centered #fb_dialog_loader_spinner{width:100%}.fb_dialog.fb_dialog_mobile.loading.centered .fb_dialog_content{background:none}.loading.centered #fb_dialog_loader_close{color:#fff;display:block;padding-top:20px;clear:both;font-size:18px}#fb-root #fb_dialog_ipad_overlay{background:rgba(0, 0, 0, .45);position:absolute;bottom:0;left:0;right:0;top:0;width:100%;min-height:100%;z-index:10000}#fb-root #fb_dialog_ipad_overlay.hidden{display:none}.fb_dialog.fb_dialog_mobile.loading iframe{visibility:hidden}.fb_dialog_content .dialog_header{-webkit-box-shadow:white 0 1px 1px -1px inset;background:-webkit-gradient(linear, 0% 0%, 0% 100%, from(#738ABA), to(#2C4987));border-bottom:1px solid;border-color:#1d4088;color:#fff;font:14px Helvetica, sans-serif;font-weight:bold;text-overflow:ellipsis;text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0;vertical-align:middle;white-space:nowrap}.fb_dialog_content .dialog_header table{-webkit-font-smoothing:subpixel-antialiased;height:43px;width:100%}.fb_dialog_content .dialog_header td.header_left{font-size:12px;padding-left:5px;vertical-align:middle;width:60px}.fb_dialog_content .dialog_header td.header_right{font-size:12px;padding-right:5px;vertical-align:middle;width:60px}.fb_dialog_content .touchable_button{background:-webkit-gradient(linear, 0% 0%, 0% 100%, from(#4966A6), color-stop(.5, #355492), to(#2A4887));border:1px solid #2f477a;-webkit-background-clip:padding-box;-webkit-border-radius:3px;-webkit-box-shadow:rgba(0, 0, 0, .117188) 0 1px 1px inset, rgba(255, 255, 255, .167969) 0 1px 0;display:inline-block;margin-top:3px;max-width:85px;line-height:18px;padding:4px 12px;position:relative}.fb_dialog_content .dialog_header .touchable_button input{border:none;background:none;color:#fff;font:12px Helvetica, sans-serif;font-weight:bold;margin:2px -12px;padding:2px 6px 3px 6px;text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0}.fb_dialog_content .dialog_header .header_center{color:#fff;font-size:16px;font-weight:bold;line-height:18px;text-align:center;vertical-align:middle}.fb_dialog_content .dialog_content{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/y9/r/jKEcVPZFk-2.gif) no-repeat 50% 50%;border:1px solid #555;border-bottom:0;border-top:0;height:150px}.fb_dialog_content .dialog_footer{background:#f6f7f8;border:1px solid #555;border-top-color:#ccc;height:40px}#fb_dialog_loader_close{float:left}.fb_dialog.fb_dialog_mobile .fb_dialog_close_button{text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0}.fb_dialog.fb_dialog_mobile .fb_dialog_close_icon{visibility:hidden}#fb_dialog_loader_spinner{animation:rotateSpinner 1.2s linear infinite;background-color:transparent;background-image:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/yD/r/t-wz8gw1xG1.png);background-repeat:no-repeat;background-position:50% 50%;height:24px;width:24px}@keyframes rotateSpinner{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.fb_iframe_widget{display:inline-block;position:relative}.fb_iframe_widget span{display:inline-block;position:relative;text-align:justify}.fb_iframe_widget iframe{position:absolute}.fb_iframe_widget_fluid_desktop,.fb_iframe_widget_fluid_desktop span,.fb_iframe_widget_fluid_desktop iframe{max-width:100%}.fb_iframe_widget_fluid_desktop iframe{min-width:220px;position:relative}.fb_iframe_widget_lift{z-index:1}.fb_hide_iframes iframe{position:relative;left:-10000px}.fb_iframe_widget_loader{position:relative;display:inline-block}.fb_iframe_widget_fluid{display:inline}.fb_iframe_widget_fluid span{width:100%}.fb_iframe_widget_loader iframe{min-height:32px;z-index:2;zoom:1}.fb_iframe_widget_loader .FB_Loader{background:url(https://fbstatic-a.akamaihd.net/rsrc.php/v2/y9/r/jKEcVPZFk-2.gif) no-repeat;height:32px;width:32px;margin-left:-16px;position:absolute;left:50%;z-index:4}</style><script charset="UTF-8" async="" src="Comprendre%20et%20ma%C3%AEtriser%20les%20subtrees%20Git%20%E2%80%A2%20Git%20Attitude%C2%A0:%20formations%20Git%20qualitatives%20et%20sympathiques_fichiers/alfie.js"></script></head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="http://www.git-attitude.fr/">Git Attitude</a></h1>
  
    <h2>La gestion de sources qui fait du bien</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://www.git-attitude.fr/atom.xml" rel="subscribe-rss" title="S’abonner au flux RSS">RSS</a></li>
  
</ul>
  
<form action="http://www.google.fr/search" method="get">
  <fieldset role="search">
    <input name="q" value="site:www.git-attitude.fr" type="hidden">
    <input class="search" name="q" results="0" placeholder="Rechercher" type="text">
  </fieldset><fieldset class="mobile-nav"><select><option value="">Naviguer…</option><option value="http://www.git-attitude.fr/">» Accueil</option><option value="http://www.git-attitude.fr/blog/archives">» Archives</option><option value="http://www.git-attitude.fr/tout-sur-les-ateliers/">» Tout sur les ateliers de formation</option><option value="http://www.git-attitude.fr/informations-generales/">» Infos &amp; Contact</option><option selected="selected" value="http://www.git-attitude.fr/atom.xml">» RSS</option></select></fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="http://www.git-attitude.fr/">Accueil</a></li>
  <li><a href="http://www.git-attitude.fr/blog/archives">Archives</a></li>
  <li><a href="http://www.git-attitude.fr/tout-sur-les-ateliers/">Tout sur les ateliers de formation</a></li>
  <li><a href="http://www.git-attitude.fr/informations-generales/">Infos &amp; Contact</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Comprendre et maîtriser les subtrees Git</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-01-30T00:00:00+01:00" pubdate="" data-updated="true">30 janvier 2015</time>
        
         | <a href="#disqus_thread">Commentaires</a>
        
      </p>
    
  </header><ul id="toc">
<li><a href="#fondamentaux-des%20subtrees">Fondamentaux des subtrees</a></li>
<li><a href="#trois-approches+distinctes%C2%A0:+choisissez%C2%A0%21">Trois approches distinctes&nbsp;: choisissez&nbsp;!</a></li>
<li class="level3"><a href="#-la+main%C2%A0%C2%BB">«&nbsp;À la main&nbsp;»</a></li>
<li class="level3"><a href="#le-script+de+contrib%C2%A0:+git+subtree">Le script de contrib&nbsp;: <code>git subtree</code></a></li>
<li class="level3"><a href="#git-stree"><code>git-stree</code></a></li>
<li><a href="#les-subtrees+pas+%C3%A0+pas">Les subtrees pas à pas</a></li>
<li class="level3"><a href="#la-structure%20de%20notre%20subtree">La structure de notre subtree</a></li>
<li class="level3"><a href="#ajouter-un%20subtree">Ajouter un subtree</a></li>
<li class="level3"><a href="#r-cup%C3%A9rer+/+mettre+%C3%A0+jour+un+d%C3%A9p%C3%B4t+exploitant+des+subtrees">Récupérer / mettre à jour un dépôt exploitant des subtrees</a></li>
<li class="level3"><a href="#r-cup%C3%A9rer+une+mise+%C3%A0+jour+au+sein+d%E2%80%99un+subtree">Récupérer une mise à jour au sein d’un subtree</a></li>
<li class="level3"><a href="#mettre-jour+un+subtree+au+sein+d%E2%80%99un+projet+conteneur">Mettre à jour un subtree au sein d’un projet conteneur</a></li>
<li class="level3"><a href="#backporter-vers+le+d%C3%A9p%C3%B4t+central+du+subtree">Backporter vers le dépôt central du subtree</a></li>
<li class="level3"><a href="#retirer-un%20subtree">Retirer un subtree</a></li>
<li class="level3"><a href="#transformer-un+r%C3%A9pertoire+en+subtree">Transformer un répertoire en subtree</a></li>
<li class="level3"><a href="#autres-sous-commandes%20de%20git%20stree">Autres sous-commandes de <code>git stree</code></a></li>
<li><a href="#alors-j%E2%80%99utilise+quelle+approche+au+final%C2%A0?">Alors, j’utilise quelle approche au final&nbsp;?</a></li>
<li><a href="#envie-d%E2%80%99en+savoir+plus%C2%A0?">Envie d’en savoir plus&nbsp;?</a></li>
</ul>


<div class="entry-content"><p>Il y a un mois, <a href="http://www.git-attitude.fr/2014/12/31/git-submodules/">nous explorions en détail les submodules</a>&nbsp;; nous vous avions alors dit que notre prochain article de fond serait sur les subtrees, qui constituent l’alternative.</p>

<p>Comme précédemment, nous allons donc explorer le sujet en détail, en 
réalisant l’ensemble des manipulations courantes pas à pas, ensemble, 
pour en illustrer les bonnes pratiques.</p>

<!-- more -->


<p><em>(<a href="https://medium.com/@porteneuve/mastering-git-subtrees-943d29a798ec">English version of this article here</a>)</em></p>

<p>Voici l’article promis&nbsp;! Si vous n’avez pas lu le précédent, <strong>je vous y encourage fortement</strong>, ne serait-ce que pour bien avoir des éléments de comparaison, et reposer la problématique.</p>

<p>Notamment, il est important que vous ayez bien vérifié que <a href="http://www.git-attitude.fr/2014/12/31/git-submodules/#ne-vous%20trompez%20pas%20de%20solution">vous n’avez pas le choix</a>
 et qu’il faudra utiliser soit les submodules soit les subtrees, plutôt 
qu’une gestion de dépendance versionnée (qui est toujours préférable, 
quand elle est faisable).</p>

<p>Nous brosserons également systématiquement des parallèles avec les <a href="http://www.git-attitude.fr/2014/12/31/git-submodules/">submodules</a>&nbsp;; si vous avez lu l’article en question, ça vous aidera à mieux internaliser ces informations.</p>

<p>On reprendra ici la terminologie du précédent article&nbsp;: nous appellerons «&nbsp;<strong>module</strong>&nbsp;»
 ce code tiers, présent quelque part dans l’arborescence des dépôts 
conteneurs.  Pour le code du projet utilisant le module au sein de son 
arborescence, on parlera de «&nbsp;<strong>conteneur</strong>&nbsp;».</p>

<h2 id="fondamentaux-des subtrees">Fondamentaux des subtrees</h2>

<p><strong>Petit rappel de terminologie d’abord&nbsp;: en Git, un dépôt est local</strong>.  La version distante, qui ne sert qu’à l’archivage, à la collaboration et au partage, est appelée un <em>remote</em>.
  Dans la suite de cet article, quand vous lisez «&nbsp;dépôt&nbsp;» ou 
«&nbsp;dépôt Git&nbsp;», il s’agit d’un dépôt local interactif, 
c’est-à-dire d’un répertoire de travail (<em>working directory</em>) avec un <code>.git</code> à sa base.</p>

<p>Avec les subtrees, <strong>pas de dépôts imbriqués</strong>&nbsp;: on n’a qu’un dépôt, le conteneur, comme pour une codebase classique.  Donc un seul cycle de vie, et <strong>aucune particularité à gérer pour les commandes et workflows habituels</strong>.  Elle est pas belle la vie&nbsp;?</p>

<h2 id="trois-approches distinctes&nbsp;: choisissez&nbsp;!">Trois approches distinctes&nbsp;: choisissez&nbsp;!</h2>

<p>Il existe trois manières de manipuler vos subtrees&nbsp;; même s’il 
reste possible de mélanger certaines approches, d’une façon générale je 
vous recommande de partir avec une et de vous y tenir, pour éviter les 
problèmes.</p>

<h3 id="-la main&nbsp;»">«&nbsp;À la main&nbsp;»</h3>

<p>Git ne fournit <strong>pas de commande native <code>subtree</code></strong>, contrairement à ce qui se passe pour les submodules.  Les subtrees ne sont pas tant une fonctionnalité qu’un <strong>concept</strong>, une <strong>approche</strong> de gestion fournie par Git.  Ils reposent sur l’utilisation adéquate de commandes de porcelaine classiques (notamment <code>merge</code> et <code>cherry-pick</code>) et d’une commande de plomberie<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup> (<code>read-tree</code>).</p>

<p>Cette approche marche partout, elle est <strong>assez simple, finalement</strong>,
 mais nécessite une bonne compréhension du fond pour exécuter certaines 
démarches avancées.  Nous l’utiliserons comme point de base, car en nous
 offrant le contrôle fin sur les opérations, elle nous donne <strong>toute liberté</strong> sur la gestion de nos historiques, branches et graphes…</p>

<h3 id="le-script de contrib&nbsp;: git subtree">Le script de contrib&nbsp;: <code>git subtree</code></h3>

<p>En juin 2012, dans la version 1.7.11, Git s’est mis à inclure un <strong>script de contrib tiers</strong>, <code>git-subtree.sh</code>, dans la distro officielle&nbsp;; ils ont qui plus est calé leur installation binaire pour qu’une copie soit présente en <code>git-subtree</code> dans les binaires mis à disposition par l’install, de sorte que <code>git subtree</code> était utilisable, ressemblant à une commande «&nbsp;native&nbsp;».</p>

<p>Ça s’arrête toutefois là, car la «&nbsp;<a href="https://github.com/git/git/blob/master/contrib/subtree/git-subtree.txt">documentation</a>&nbsp;» n’est pas une page man, et n’est donc pas installée comme telle.  Les appels usuels (<code>man git-subtree</code>, <code>git help subtree</code> ou <code>git subtree --help</code>) sont inopérants.  Un <code>git subtree</code>
 tout court nous donne just le synopsis, sans plus d’informations.  Seul
 le fichier texte lié en début de paragraphe fournit les infos, et il 
est <strong>planqué</strong> au fin fond du dossier <code>contrib/</code> de votre installation Git.</p>

<p>Ce script, que j’appellerai par souci de concision <code>git subtree</code> dans la suite de cet article, a le mérite d’être <strong>robuste</strong> et de proposer des <strong>syntaxes familières</strong> (<code>add</code>, <code>pull</code>, <code>push</code>…) par-dessus des opérations parfois complexes.  Il offre toutefois quelques opérations (genre <code>split</code>) et notions (genre <code>--ignore-joins/--rejoin</code>) qui sont assez <strong>déroutantes</strong> au premier abord, sans parler de son approche très personnelle du <code>--squash</code>…</p>

<p>Mais surtout, il <strong>maintient une branche dédiée au subtree</strong>, qui va fusionner dans la branche courante à chaque <code>git subtree pull</code> ou <code>git subtree merge</code>.  Ce qui veut dire qu’elle va nous <strong>pourrir le graphe</strong> de l’historique en permanence, et ça, moi, j’ai énormément de mal.</p>

<p>Autre inconvénient&nbsp;: elle ne permet pas de choisir les <strong>commits locaux sur le subtree</strong> qu’on veut backporter avec un <code>git subtree push</code>&nbsp;: <strong>c’est tout ou rien</strong>.
  Alors qu’un intérêt des subtrees c’est justement de pouvoir faire des 
modifs locales custom autant que des fixes à portée générale.</p>

<p>Toutefois, elle a le mérite d’être là depuis longtemps et d’être donc abondamment testée (et notamment <em>battle-tested</em>), ce qui n’est pas à négliger.</p>

<h3 id="git-stree"><code>git-stree</code></h3>

<p>Énervé depuis longtemps par cette alternative désagréable entre les 
commandes manuelles d’un côté, qui rebuttent pas mal de monde, et 
l’approche de <code>git subtree</code>, qui pourrit le graphe et requiert des CLIs à rallonge, j’ai fini par <strong>pondre mon propre script&nbsp;: <code>git-stree</code></strong>.</p>

<p>La mauvaise nouvelle d’abord&nbsp;: c’est pas encore testé à fond les
 ballons&nbsp;; ça marche pour tous mes usages et démos, ceci dit.</p>

<p>Les bonnes nouvelles ensuite&nbsp;:</p>

<ul>
<li>Je travaille à une couverture de tests exhaustive, utilisant l’infra de tests de Git&nbsp;;</li>
<li>Y’a une <strong>aide détaillée intégrée</strong> à <code>git help stree</code> et <code>git stree --help</code> (et en plus, <a href="http://tdd.github.io/git-stree/">un site officiel</a> encore plus détaillé)&nbsp;;</li>
<li>Je fournis une <strong>complétion</strong> Bash intelligente&nbsp;;</li>
<li>Pas besoin de répéter toute la config en CLI à chaque fois&nbsp;;</li>
<li><strong>Ne pourrit pas le graphe</strong>, car évite de fusionner une branche dédiée à chaque fois&nbsp;;</li>
<li>Permet de <strong>choisir les commits</strong> locaux (conteneur) <strong>à backporter</strong> vers le dépôt central du subtree.</li>
</ul>


<p>Bref, j’ai fait la liste de ce que j’aimerais, et je l’ai codé.</p>

<p>Si ça vous tente, <a href="http://tdd.github.io/git-stree/">c’est par ici</a>.</p>

<h2 id="les-subtrees pas à pas">Les subtrees pas à pas</h2>

<p>Nous allons à présent explorer chaque étape de l’utilisation de 
subtrees dans un projet collaboratif, avec le déroulé pour chacune des 
trois approches.</p>

<p>Afin que vous puissiez pratiquer ces exemples par vous-mêmes, je vous ai préparé une série de <strong>dépôts d’exemple</strong>
 avec leurs «&nbsp;remotes&nbsp;» qui sont en fait juste des 
répertoires.  Vous pouvez décompresser l’archive où vous voulez et 
ouvrir un shell (ou un Git Bash, pour ceux sous Windows) dans le dossier
 <code>git-subs</code> ainsi obtenu&nbsp;:</p>

<p><a href="http://www.git-attitude.fr/assets/git-subs-demo.zip">Téléchargez les dépôts d’exemple</a></p>

<p>Vous y trouverez trois dossiers&nbsp;:</p>

<ul>
<li><code>main</code> joue le rôle du dépôt <strong>conteneur</strong>, local à un premier collaborateur</li>
<li><code>plugin</code> joue le rôle du <strong>dépôt central de maintenance</strong> d’un module</li>
<li><code>remotes</code> contient les <em>filesystem remotes</em> pour ces dépôts</li>
</ul>


<p>Dans les exemples de commandes ci-après, le prompt indique toujours 
l’approche qui est illustrée et le dépôt dans lequel on se trouve.</p>

<p>Si vous voulez tester <strong>plusieurs approches en parallèle</strong>, je vous invite à <strong>dupliquer le dossier racine</strong>, <code>git-subs</code>, autant de fois que nécessaire, pour pouvoir comparer les résultats à la volée.</p>

<h3 id="la-structure de notre subtree">La structure de notre subtree</h3>

<p>Elle est assez simple&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">.
</span><span class="line">├── README.md
</span><span class="line">├── lib
</span><span class="line">│&nbsp;&nbsp; └── index.js
</span><span class="line">└── plugin-config.json
</span></code></pre></td></tr></tbody></table></div></figure>


<p>À chaque fois, on va vouloir exploiter ce contenu au sein de notre codebase conteneur, dans le sous-dossier <code>vendor/plugins/demo</code>.</p>

<h3 id="ajouter-un subtree">Ajouter un subtree</h3>

<h4>À la main</h4>

<p>Commençons par nous épargner des CLIs atroces en définissant un <em>remote</em> pour le dépôt central du subtree, qu’on va récupérer dans le cache local ensuite&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">a-la-main/main (master u=) $ git remote add plugin ../remotes/plugin
</span><span class="line">a-la-main/main (master u=) $ git fetch plugin
</span><span class="line">warning: no common commits
</span><span class="line">remote: Counting objects: 11, done.
</span><span class="line">remote: Compressing objects: 100% (9/9), done.
</span><span class="line">remote: Total 11 (delta 1), reused 0 (delta 0)
</span><span class="line">Unpacking objects: 100% (11/11), done.
</span><span class="line">From ../remotes/plugin
</span><span class="line"> * [new branch]      master     -&gt; plugin/master
</span><span class="line">a-la-main/main (master u=) $
</span></code></pre></td></tr></tbody></table></div></figure>


<p>Il nous faut à présent retranscrire le contenu de la branche <code>master</code> du plugin dans le sous-dossier qui va bien, et ajouter ça à l’index au passage.  C’est le rôle de <code>read-tree</code>, qui lit une arbo dans la base et la retranscrit dans l’index, <em>en préfixant la racine si besoin</em>.  L’option <code>-u</code> est là pour mettre également à jour le <em>working directory</em> (ce qui est plutôt une bonne idée…).</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">a-la-main/main (master u=) $ git read-tree --prefix=vendor/plugins/demo -u plugin/master
</span><span class="line">a-la-main/main (master + u=) $ git status
</span><span class="line">On branch master
</span><span class="line">Your branch is up-to-date with 'origin/master'.
</span><span class="line">Changes to be committed:
</span><span class="line">  (use "git reset HEAD &lt;file&gt;..." to unstage)
</span><span class="line">
</span><span class="line">  new file:   vendor/plugins/demo/README.md
</span><span class="line">  new file:   vendor/plugins/demo/lib/index.js
</span><span class="line">  new file:   vendor/plugins/demo/plugin-config.json
</span></code></pre></td></tr></tbody></table></div></figure>


<p>Impeccable.  Finalisons le commit dédié&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">a-la-main/main (master + u=) $ git commit -m "Ajout du plugin de démo en subtree dans vendor/plugins/demo"
</span><span class="line">[master 76b347a] Ajout du plugin de démo en subtree dans vendor/plugins/demo
</span><span class="line"> 3 files changed, 19 insertions(+)
</span><span class="line"> create mode 100644 vendor/plugins/demo/README.md
</span><span class="line"> create mode 100644 vendor/plugins/demo/lib/index.js
</span><span class="line"> create mode 100644 vendor/plugins/demo/plugin-config.json
</span><span class="line">a-la-main/main (master u+1) $
</span></code></pre></td></tr></tbody></table></div></figure>


<p>Et voilà&nbsp;! Rien de bien compliqué&nbsp;!</p>

<h4>Avec <code>git subtree</code></h4>

<p>Là aussi, définir le <em>remote</em> raccourcit les CLI qui suivent, mais pas besoin du <code>fetch</code> manuel, <code>git subtree</code> le fera le moment venu.  On utilise la sous-commande <code>add</code>&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">git-subtree/main (master u=) $ git remote add plugin ../remotes/plugin/
</span><span class="line">git-subtree/main (master u=) $ git subtree add --prefix=vendor/plugins/demo plugin master
</span><span class="line">git fetch plugin master
</span><span class="line">warning: no common commits
</span><span class="line">remote: Counting objects: 11, done.
</span><span class="line">remote: Compressing objects: 100% (9/9), done.
</span><span class="line">remote: Total 11 (delta 1), reused 0 (delta 0)
</span><span class="line">Unpacking objects: 100% (11/11), done.
</span><span class="line">From ../remotes/plugin
</span><span class="line"> * branch            master     -&gt; FETCH_HEAD
</span><span class="line"> * [new branch]      master     -&gt; plugin/master
</span><span class="line">Added dir 'vendor/plugins/demo'
</span><span class="line">git-subtree/main (master u+4) $
</span></code></pre></td></tr></tbody></table></div></figure>


<p>OK, remarquez le dernier prompt&nbsp;: la commande a <strong>fusionné les historiques du plugin et du conteneur</strong>.  Vérifions avec un log&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">git-subtree/main (master u+4) $ git log --oneline --graph --decorate
</span><span class="line">*   32e539d (HEAD, master) Add 'vendor/plugins/demo/' from commit 'fe6479991d214f4d95ac2ae959d7252a866e01a3'
</span><span class="line">|\
</span><span class="line">| * fe64799 (plugin/master) Fix repo name for main project companion demo repo
</span><span class="line">| * 89d24ad Main files (incl. subdir) for plugin, to populate its tree.
</span><span class="line">| * cc88751 Initial commit
</span><span class="line">* b90985a (origin/master) Main files for the project, to populate its tree a bit.
</span><span class="line">* e052943 Initial import
</span></code></pre></td></tr></tbody></table></div></figure>


<p>Si vous êtes comme moi, vous n’aimez pas trop polluer votre 
historique conteneur avec le détail des commits centraux du subtree…  On
 <strong>pourrait croire</strong> qu’on tient la solution avec l’option <code>--squash</code> que <code>git subtree</code> propose pour ses sous-commandes <code>add</code>, <code>pull</code> et <code>merge</code>.  Après tout, <code>git merge --squash</code> produit un <em>squash commit</em> au lieu d’une fusion, ce qui correspond mieux à ce qu’on voudrait.</p>

<p>Oui, <strong>mais non</strong>&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">git-subtree/main (master u+4) $ git reset --hard @{u}
</span><span class="line">HEAD is now at b90985a Main files for the project, to populate its tree a bit.
</span><span class="line">git-subtree/main (master u=) $ git subtree add --prefix=vendor/plugins/demo --squash plugin master
</span><span class="line">git fetch plugin master
</span><span class="line">From ../remotes/plugin
</span><span class="line"> * branch            master     -&gt; FETCH_HEAD
</span><span class="line">Added dir 'vendor/plugins/demo'
</span><span class="line">git-subtree/main (master u+2) $
</span></code></pre></td></tr></tbody></table></div></figure>


<p>Vous avez vu le <code>u+2</code> dans le prompt, au lieu d’un <code>u+1</code>&nbsp;? Voyons voir&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">git-subtree/main (master u+2) $ git log --oneline --graph --decorate
</span><span class="line">*   352af7a (HEAD, master) Merge commit '03e04026fdba2ff1200a226c3dd8a4bb66c97a51' as 'vendor/plugins/demo'
</span><span class="line">|\
</span><span class="line">| * 03e0402 Squashed 'vendor/plugins/demo/' content from commit fe64799
</span><span class="line">* b90985a (origin/master) Main files for the project, to populate its tree a bit.
</span><span class="line">* e052943 Initial import
</span></code></pre></td></tr></tbody></table></div></figure>


<p>Et voilà…  Au lieu de faire un <em>squash commit</em>, il <em>squashe</em>
 l’historique concerné du subtree, en fait un commit sur la 
«&nbsp;branche&nbsp;» dédiée (ce n’est pas à proprement parler une 
branche, mais ça y ressemble dans le graphe), et fusionne ça.</p>

<p>Vu son fonctionnement interne et les commandes qu’il propose, je 
comprends qu’il ait besoin de ça.  C’est techniquement justifié pour la 
suite, mais personnellement <strong>ça me gêne</strong>.</p>

<h4>Avec <code>git stree</code></h4>

<p>Alors, envie de tester mon approche&nbsp;?  Cool&nbsp;!  Assurez-vous d’avoir <a href="http://tdd.github.io/git-stree/">bien installé ça</a>, et on y va.</p>

<p>Déjà, pas besoin de définir un <em>remote</em> dédié&nbsp;: la sous-commande <code>add</code> est seule à avoir besoin des détails, qu’elle enregistre en configuration locale.  Vous allez <strong>nommer le subtree</strong>, et utiliser ce simple nom par la suite, au lieu de répéter des infos détaillées.  Voyez plutôt&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">git-stree/main (master u=) $ git stree add demo -P vendor/plugins/demo ../remotes/plugin master
</span><span class="line">warning: no common commits
</span><span class="line">[master bff66fa] [STree] Added stree 'demo' in vendor/plugins/demo
</span><span class="line"> 3 files changed, 19 insertions(+)
</span><span class="line"> create mode 100644 vendor/plugins/demo/README.md
</span><span class="line"> create mode 100644 vendor/plugins/demo/lib/index.js
</span><span class="line"> create mode 100644 vendor/plugins/demo/plugin-config.json
</span><span class="line">
</span><span class="line">✔︎ STree 'demo' configured, 1st injection committed.
</span><span class="line">
</span><span class="line">git-stree/main (master u+1) $
</span></code></pre></td></tr></tbody></table></div></figure>


<p>Et voilà, <strong>un seul commit dédié</strong>, dont vous voyez le 
message en deuxième ligne.  La configuration locale est désormais 
porteuse de quelques infos dédiées pour ce subtree «&nbsp;demo&nbsp;» 
que vous venez de créer&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">git-stree/main (master u+1) $ tail -n 7 .git/config
</span><span class="line">[remote "stree-demo"]
</span><span class="line">  url = ../remotes/plugin
</span><span class="line">  fetch = +refs/heads/master:refs/remotes/stree-demo/master
</span><span class="line">[stree "demo"]
</span><span class="line">  prefix = vendor/plugins/demo
</span><span class="line">  branch = master
</span><span class="line">  latest-sync = bff66fa
</span></code></pre></td></tr></tbody></table></div></figure>


<p>Primo, un <em>remote</em> dédié a été créé, avec un nom qui ne 
devrait pas entrer en conflit avec ceux déjà définis.  Secundo, les 
infos de gestion (préfixe dans le <em>working directory</em>, <em>remote</em> et branche distante, dernier commit injecté) sont persistées.</p>

<h3 id="r-cupérer / mettre à jour un dépôt exploitant des subtrees">Récupérer / mettre à jour un dépôt exploitant des subtrees</h3>

<p>OK.  À présent que nous avons vu comment ajouter un subtree, <strong>nos collègues doivent-ils faire quelque chose de particulier pour en profiter</strong> dans leurs dépôts locaux&nbsp;?</p>

<p>Après tout, si on utilisait des submodules, ils auraient besoin soit d’un <code>git clone --recursive</code> pour récupérer le dépôt, soit d’une séquence <code>git fetch</code> + <code>git submodule sync --recursive</code> + <code>git submodule update --init --recursive</code> sur un dépôt déjà présent.  La fête, quoi.</p>

<p>Et bien vous savez quoi&nbsp;?  Là, <strong>ils n’ont rien de plus à faire</strong> que d’habitude.  La raison est simple&nbsp;: il y a <strong>un seul dépôt</strong>&nbsp;: le conteneur.</p>

<p>Vérifions ça.  Commençons par partager le(s) commit(s) d’ajout du 
subtree, pour que nos collègues puissent cloner ou synchroniser leurs 
dépôts depuis le <em>remote</em>.  Dans chaque dossier où vous avez fait une manip’, faites un <code>git push</code>.</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">git-stree/main (master u+1) $ git push
</span><span class="line">…
</span><span class="line">git-subtree/main (master u+2) $ git push
</span><span class="line">…
</span><span class="line">a-la-main/main (master u+1) $ git push
</span><span class="line">…
</span></code></pre></td></tr></tbody></table></div></figure>


<p>Pour récupérer le dépôt à jour, <strong>il suffit de le cloner/puller normalement</strong>.  La manip’ est la même quelle que soit l’approche initiale, alors je ne vous la montre qu’une fois&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">a-la-main/main (master u=) $ cd ..
</span><span class="line">a-la-main $ git clone remotes/main collegue
</span><span class="line">Cloning into 'collegue'...
</span><span class="line">done.
</span><span class="line">a-la-main $ cd collegue
</span><span class="line">a-la-main/collegue (master u=) $ tree vendor
</span><span class="line">vendor
</span><span class="line">└── plugins
</span><span class="line">    └── demo
</span><span class="line">        ├── README.md
</span><span class="line">        ├── lib
</span><span class="line">        │&nbsp;&nbsp; └── index.js
</span><span class="line">        └── plugin-config.json
</span><span class="line">
</span><span class="line">3 directories, 3 files
</span></code></pre></td></tr></tbody></table></div></figure>


<p><em>(Dans le Git Bash sur Windows, vous n’aurez pas la commande <code>tree</code>,
 pas plus que sur un OSX ou certains Linux bruts de décoffrage&nbsp;: il
 faut installer la commande.  Ouvrez juste votre explorateur de 
fichiers, ou faites un <code>ls -lR</code> à la place.)</em></p>

<h4>Un mot sur l’approche <code>git stree</code></h4>

<p>Cette commande a besoin de la définition du subtree dans la 
configuration locale.  Par définition, ces infos ne sont pas transmises 
au <em>push</em>, et donc pas partagées avec les collègues.  Si mon 
collègue voulait commencer à manipuler le subtree lui aussi, il lui 
faudrait repiquer ces infos depuis la configuration locale du premier 
intervenant, ou refaire un <code>git stree add</code> identique de son côté.</p>

<p>Pour fluidifier tout ça, je travaille à la maintenance d’un fichier <code>.gitstrees</code> à la racine du dépôt, dans le genre du <code>.gitmodules</code> des submodules, et à une sous-commande <code>git stree sync</code>
 qui reflèterait ces infos dans la config locale (et serait 
automatiquement appelée par toute autre sous-commande, histoire d’éviter
 d’avoir à la faire à la main la plupart du temps).</p>

<p>Ceci étant dit, il est rare que plusieurs intervenants gèrent un même
 subtree / submodule dans une codebase&nbsp;: c’est souvent la 
responsabilité exclusive d’une personne, qui peut donc être la seule à 
avoir la configuration locale nécessaire.</p>

<h3 id="r-cupérer une mise à jour au sein d’un subtree">Récupérer une mise à jour au sein d’un subtree</h3>

<p>À présent que nous avons notre propre dépôt (main) et celui de notre «
 collègue » (collegue) mis en place pour collaborer, mettons-nous dans 
la peau d’une troisième personne : celle qui maintient le plugin. Allez 
hop, on se met dedans&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">a-la-main/collegue (master u=) $ cd ../plugin
</span><span class="line">a-la-main/plugin (master u=) $ git log --oneline
</span><span class="line">fe64799 Fix repo name for main project companion demo repo
</span><span class="line">89d24ad Main files (incl. subdir) for plugin, to populate its tree.
</span><span class="line">cc88751 Initial commit
</span></code></pre></td></tr></tbody></table></div></figure>


<p>Et maintenant, faisons deux pseudo-commits et publions-les sur le <em>remote</em>&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">a-la-main/plugin (master u=) $ date &gt; fake-work
</span><span class="line">a-la-main/plugin (master % u=) $ git add fake-work
</span><span class="line">a-la-main/plugin (master + u=) $ git commit -m "Pseudo-commit n°1"
</span><span class="line">[master 5048a7d] Pseudo-commit n°1
</span><span class="line"> 1 file changed, 1 insertion(+)
</span><span class="line"> create mode 100644 fake-work
</span><span class="line">
</span><span class="line"> a-la-main/plugin (master u+1) $ date &gt;&gt; fake-work
</span><span class="line">a-la-main/plugin (master * u+1) $ git commit -am "Pseudo-commit n°2"
</span><span class="line">a-la-main/plugin (master u+2) $ git push
</span></code></pre></td></tr></tbody></table></div></figure>


<p>Enfin, remettons notre casquette «&nbsp;premier développeur&nbsp;»&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">a-la-main/plugin (master u=) $ cd ../main
</span><span class="line">a-la-main/main (master u=) $
</span></code></pre></td></tr></tbody></table></div></figure>


<p>Pensez à répéter ces opérations sur les duplications que vous auriez mises en place pour d’autres approches (<code>git subtree</code> ou <code>git stree</code>)…</p>

<p>Imaginons à présent que nous souhaitions récupérer ces deux commits dans notre subtree.</p>

<h4>À la main</h4>

<p>C’est tout facile, en fait, il nous suffit de mettre à jour notre cache local sur la base du <em>remote</em> du plugin, et de faire un <em>subtree merge</em> (on fera un <em>squash commit</em>,
 en revanche, histoire d’éviter de fusionner les historiques).  La 
plupart du temps, nous n’aurons même pas besoin de re-préciser le 
préfixe de chemin, il se débrouillera tout seul&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">a-la-main/main (master u=) $ git fetch plugin
</span><span class="line">remote: Counting objects: 6, done.
</span><span class="line">remote: Compressing objects: 100% (5/5), done.
</span><span class="line">remote: Total 6 (delta 1), reused 0 (delta 0)
</span><span class="line">Unpacking objects: 100% (6/6), done.
</span><span class="line">From ../remotes/plugin
</span><span class="line">   fe64799..dc995bf  master     -&gt; plugin/master
</span><span class="line">
</span><span class="line">a-la-main/main (master u=) $ git merge -s subtree --squash plugin/master
</span><span class="line">Squash commit -- not updating HEAD
</span><span class="line">Automatic merge went well; stopped before committing as requested
</span><span class="line">
</span><span class="line">a-la-main/main (master + u=) $ git status
</span><span class="line">On branch master
</span><span class="line">Your branch is up-to-date with 'origin/master'.
</span><span class="line">Changes to be committed:
</span><span class="line">  (use "git reset HEAD &lt;file&gt;..." to unstage)
</span><span class="line">
</span><span class="line">  new file:   vendor/plugins/demo/fake-work
</span><span class="line">
</span><span class="line">a-la-main/main (master + u=) $ git commit -m "Mise à jour du subtree du plugin de démo"
</span><span class="line">[master 4f9a839] Mise à jour du subtree du plugin de démo
</span><span class="line"> 1 file changed, 2 insertions(+)
</span><span class="line"> create mode 100644 vendor/plugins/demo/fake-work
</span><span class="line">a-la-main/main (master u+1) $
</span></code></pre></td></tr></tbody></table></div></figure>


<p>Comme toujours, un <em>squash merge</em> ne finalise pas le 
commit&nbsp;; et d’ailleurs, c’est pratique lorsque les mises à jour du 
subtree nécessitent un ajustement du code du conteneur pour que 
l’ensemble fonctionne&nbsp;: ça permet de ne faire qu’un commit, 
directement opérationnel.</p>

<p>Dans certains cas, il peut arriver que les heuristiques de détermination du préfixe de la stratégie de fusion <code>subtree</code> se paument&nbsp;; il vous est alors possible de rester dans la stratégie de fusion par défaut (<code>recursive</code>), mais de préciser le préfixe <em>via</em> l’option de fusion <code>subtree</code>.  On aurait alors démarré la séquence ci-avant comme ceci&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">git merge -X subtree=vendor/plugins/demo --squash plugin/master
</span></code></pre></td></tr></tbody></table></div></figure>


<p>Un peu plus long, mais pratique pour les quelques cas où l’heuristique par défaut perd pied.</p>

<h4>Avec <code>git subtree</code></h4>

<p>C’est le rôle de la sous-commande <code>pull</code>.  Comme pour l’ajout initial, histoire de ne pas fusionner le détail de l’historique du plugin, on utilisera <code>--squash</code>.  Et on doit répéter toute la config à chaque appel&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">git-subtree/main (master u=) $ git subtree pull --prefix=vendor/plugins/demo --squash plugin master
</span><span class="line">remote: Counting objects: 6, done.
</span><span class="line">remote: Compressing objects: 100% (5/5), done.
</span><span class="line">remote: Total 6 (delta 1), reused 0 (delta 0)
</span><span class="line">Unpacking objects: 100% (6/6), done.
</span><span class="line">From ../remotes/plugin
</span><span class="line"> * branch            master     -&gt; FETCH_HEAD
</span><span class="line">   fe64799..2872e5d  master     -&gt; plugin/master
</span><span class="line">Merge made by the 'recursive' strategy.
</span><span class="line"> vendor/plugins/demo/fake-work | 2 ++
</span><span class="line"> 1 file changed, 2 insertions(+)
</span><span class="line"> create mode 100644 vendor/plugins/demo/fake-work
</span><span class="line">git-subtree/main (master u+2) $
</span></code></pre></td></tr></tbody></table></div></figure>


<p>Mais ça va <em>quand même</em> maintenir la branche et nous pourrir le graphe&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">git-subtree/main (master u+2) $ git log --oneline --graph --decorate
</span><span class="line">*   1782c08 (HEAD, master) Merge commit '636facf64d416210e90bb8b83396f573f89b20c5'
</span><span class="line">|\
</span><span class="line">| * 636facf Squashed 'vendor/plugins/demo/' changes from fe64799..2872e5d
</span><span class="line">* |   352af7a (origin/master) Merge commit '03e04026fdba2ff1200a226c3dd8a4bb66c97a51' as 'vendor/plugins/demo'
</span><span class="line">|\ \
</span><span class="line">| |/
</span><span class="line">| * 03e0402 Squashed 'vendor/plugins/demo/' content from commit fe64799
</span><span class="line">* b90985a Main files for the project, to populate its tree a bit.
</span><span class="line">* e052943 Initial import
</span></code></pre></td></tr></tbody></table></div></figure>


<p>Woh pinaise…  Et souvenez-vous&nbsp;: le conteneur n’a à ce stade qu’une seule branche&nbsp;: <code>master</code>.  Ça saute aux yeux en regardant ce graphe, non&nbsp;?  Pfff…</p>

<h4>Avec <code>git stree</code></h4>

<p>On a déjà défini le subtree en lui donnant son p’tit nom, y’a plus qu’à&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">git-stree/main (master u=) $ git stree pull demo
</span><span class="line">
</span><span class="line">[master 2359d20] [STree] Pulled stree 'demo'
</span><span class="line"> 1 file changed, 2 insertions(+)
</span><span class="line"> create mode 100644 vendor/plugins/demo/fake-work
</span><span class="line">✔︎ STree 'demo' pulled, updates committed.
</span><span class="line">
</span><span class="line">git-stree/main (master u+1) $
</span></code></pre></td></tr></tbody></table></div></figure>


<p>Perso, je préfère 😝</p>

<h3 id="mettre-jour un subtree au sein d’un projet conteneur">Mettre à jour un subtree au sein d’un projet conteneur</h3>

<p>Il peut arriver qu’un code ne puisse être exploité qu’au sein d’un 
projet conteneur, notamment pour le mettre au point et le tester ; on 
pense aux plugins, aux thèmes, etc.  Dans de tels cas, vous allez 
forcément le faire évoluer <strong>directement dans la codebase d’un conteneur</strong>, avant de <strong>backporter ça</strong> sur son <em>remote</em> central.</p>

<p>Il peut aussi arriver, et c’est là une possibilité des subtrees qu’on
 ne peut pas répliquer proprement avec les submodules, que vous 
souhaitiez <strong>personnaliser le code du subtree uniquement dans le cadre de votre projet conteneur</strong>, sans remonter ça <em>upstream</em>.</p>

<p>Il est important de bien découper les deux types de manipulation dans des commits distincts.</p>

<p>En revanche, dans le premier cas, si ça nécessite par-dessus le 
marché des modifs dans le code conteneur, il n’est pas obligatoire de 
faire 2 commits séparés (un pour le subtree, un pour le 
conteneur)&nbsp;: les commandes exploitées plus tard pour le backport 
devraient retrouver leurs petits, et ça vous évitera un commit 
intermédiaire qui fait échouer les tests…</p>

<p>Quelle que soit l’approche retenue, <strong>ces mises à jour se font librement dans la codebase conteneur</strong>, qui est l’unique dépôt contenant et le code conteneur, et celui des subtrees.  Les collaborateurs n’ont <strong>aucune manip’ particulière à faire</strong>&nbsp;: c’est comme si le subtree n’en était pas un.  C’est là un <strong>énorme avantage sur les submodules</strong>, où cette section de l’article est beaucoup, beaucoup plus longue…</p>

<p>Déroulons un scénario qui mélangera quatre types de commits&nbsp;:</p>

<ul>
<li>Commits sur le subtree uniquement, destinés au backport (fixes, etc.)&nbsp;;</li>
<li>Commits sur le code conteneur uniquement&nbsp;;</li>
<li>Commits sur le subtree et le conteneur, dont la partie subtree doit être backportée&nbsp;;</li>
<li>Commits sur le subtree uniquement, spécifiques au conteneur et donc à ne pas backporter.</li>
</ul>


<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">a-la-main/main (master u=) $ echo '// Now super fast' &gt;&gt; vendor/plugins/demo/lib/index.js
</span><span class="line">a-la-main/main (master * u=) $ git ci -am "[To backport] Plugin plus rapide"
</span><span class="line">a-la-main/main (master u+1) $ date &gt;&gt; main-file-1
</span><span class="line">a-la-main/main (master * u+1) $ git ci -am "Boulot conteneur seul"
</span><span class="line">a-la-main/main (master u+2) $ date &gt;&gt; vendor/plugins/demo/fake-work
</span><span class="line">a-la-main/main (master * u+2) $ date &gt;&gt; main-file-2
</span><span class="line">a-la-main/main (master * u+2) $ git ci -am "[To backport] Horodatage plugin (nécessite un ajustement conteneur)"
</span><span class="line">a-la-main/main (master u+3) $ echo '// This is just for this specific container' &gt;&gt; vendor/plugins/demo/lib/index.js
</span><span class="line">a-la-main/main (master * u+3) $ git ci -am "MàJ du plugin uniquement dans le contexte courant"
</span></code></pre></td></tr></tbody></table></div></figure>


<p>Comme précédemment, pensez à rejouer ce scénario sur les duplications
 que vous auriez faites pour tester les autres approches…  Les manips 
seront identiques à chaque fois.  Pour les fans du gros copier-coller 
qui tâche, voici la liste des commandes brutes&nbsp;; mais prenez soin 
de vérifier que chacune a bien fonctionné comme prévu&nbsp;!</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">echo '// Now super fast' &gt;&gt; vendor/plugins/demo/lib/index.js
</span><span class="line">git ci -am "[To backport] Plugin plus rapide"
</span><span class="line">date &gt;&gt; main-file-1
</span><span class="line">git ci -am "Boulot conteneur seul"
</span><span class="line">date &gt;&gt; vendor/plugins/demo/fake-work
</span><span class="line">date &gt;&gt; main-file-2
</span><span class="line">git ci -am "[To backport] Horodatage plugin (nécessite un ajustement conteneur)"
</span><span class="line">echo '// This is just for this specific container' &gt;&gt; vendor/plugins/demo/lib/index.js
</span><span class="line">git ci -am "MàJ du plugin uniquement dans le contexte courant"
</span></code></pre></td></tr></tbody></table></div></figure>


<h3 id="backporter-vers le dépôt central du subtree">Backporter vers le dépôt central du subtree</h3>

<p>À présent, nous allons voir comment backporter juste le nécessaire, 
approche par approche.  Commençons par regarder nos commits récents, 
histoire de bien avoir l’historique en tête&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">a-la-main/main (master u+4) $ git log --oneline --decorate --stat -5
</span><span class="line">28e310b (master) MàJ du plugin uniquement dans le contexte courant
</span><span class="line"> vendor/plugins/demo/lib/index.js | 1 +
</span><span class="line"> 1 file changed, 1 insertion(+)
</span><span class="line">71d2d12 [To backport] Horodatage plugin (nécessite un ajustement conteneur)
</span><span class="line"> main-file-2                   | 1 +
</span><span class="line"> vendor/plugins/demo/fake-work | 1 +
</span><span class="line"> 2 files changed, 2 insertions(+)
</span><span class="line">c693673 Boulot conteneur seul
</span><span class="line"> main-file-1 | 1 +
</span><span class="line"> 1 file changed, 1 insertion(+)
</span><span class="line">92bc02d [To backport] Plugin plus rapide
</span><span class="line"> vendor/plugins/demo/lib/index.js | 1 +
</span><span class="line"> 1 file changed, 1 insertion(+)
</span><span class="line">4f758af (origin/master) Mise à jour du subtree du plugin de démo
</span><span class="line"> vendor/plugins/demo/fake-work | 2 ++
</span><span class="line"> 1 file changed, 2 insertions(+)
</span></code></pre></td></tr></tbody></table></div></figure>


<h4>À la main</h4>

<p>On pourrait créer des commits synthétiques au milieu de nulle part, 
mais c’est moche.  Je préfère de loin créer une branche locale dédiée au
 backport, qui tracke la branche idoine du <em>remote</em> du plugin&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">a-la-main/main (master u+4) $ git checkout -b backport-plugin plugin/master
</span><span class="line">a-la-main/main (backport-plugin u=) $
</span></code></pre></td></tr></tbody></table></div></figure>


<p>À présent, nous allons faire un <em>cherry-pick</em> des commits qui nous intéressent (en précisant <code>-x</code> tant qu’à faire, pour inclure les détails de l’origine dans le message de commit résultant).</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">a-la-main/main (backport-plugin u=) $ git cherry-pick -x master~3
</span><span class="line">[backport-plugin 953ec4d] [To backport] Plugin plus rapide
</span><span class="line"> Date: Thu Jan 29 21:54:45 2015 +0100
</span><span class="line"> 1 file changed, 1 insertion(+)
</span><span class="line">
</span><span class="line">a-la-main/main (backport-plugin u+1) $ git cherry-pick -x --strategy=subtree master^
</span><span class="line">[backport-plugin 34f50a4] [To backport] Horodatage plugin (nécessite un ajustement conteneur)
</span><span class="line"> Date: Thu Jan 29 21:55:00 2015 +0100
</span><span class="line"> 1 file changed, 1 insertion(+)
</span><span class="line">
</span><span class="line">a-la-main/main (backport-plugin u+1) $ git log --oneline --decorate --stat -2
</span><span class="line">34f50a4 (HEAD, backport-plugin) [To backport] Horodatage plugin (nécessite un ajustement conteneur)
</span><span class="line"> fake-work | 1 +
</span><span class="line"> 1 file changed, 1 insertion(+)
</span><span class="line">953ec4d [To backport] Plugin plus rapide
</span><span class="line"> lib/index.js | 1 +
</span><span class="line"> 1 file changed, 1 insertion(+)
</span><span class="line">
</span><span class="line">a-la-main/main (backport-plugin u+2) $ git push
</span><span class="line">Counting objects: 7, done.
</span><span class="line">Delta compression using up to 4 threads.
</span><span class="line">Compressing objects: 100% (6/6), done.
</span><span class="line">Writing objects: 100% (7/7), 877 bytes | 0 bytes/s, done.
</span><span class="line">Total 7 (delta 2), reused 0 (delta 0)
</span><span class="line">To ../remotes/plugin
</span><span class="line">   dc995bf..34f50a4  backport-plugin -&gt; master
</span></code></pre></td></tr></tbody></table></div></figure>


<p>Tout comme avec <code>git merge -s subtree plugin/master</code> un peu plus tôt, l’heuristique se débrouille généralement pour retrouver ses petits.</p>

<p>En fait, on remarque qu’il est même possible de <em>ne pas avoir à préciser la stratégie</em>,
 du moment que les fichiers concernés par le commit source ont des 
correspondances non ambigües dans le working directory (différent, non 
préfixé, et sans les contenus strictement conteneur) de la branche 
courante.</p>

<p>Toutefois, il est prudent de préciser <code>--strategy=subtree</code> (l’option <code>-s</code> signifie autre chose pour <code>cherry-pick</code>) pour s’assurer que le <em>cherry-pick</em> ignorera tranquillement les fichiers conteneur (hors subtree) du commit d’origine, comme par exemple <code>main-file-2</code> dans <code>master^</code>.  Si on oublie cette option, sur ce coup-là Git refuserait de finaliser le cherry-pick, en estimant que de notre côté (<code>backport-plugin</code>) on a supprimé le fichier (conflit de type <code>deleted by us</code>).  Je vous encourage à le préciser tout le temps, par prudence.</p>

<p>Le log est là pour nous rassurer quant au chemin des fichiers backportés, qui est bien en «&nbsp;racine plugin&nbsp;».  Et le <code>push</code> final partage ce backport sur le <em>remote</em> central du plugin.</p>

<h4>Avec <code>git subtree</code></h4>

<p>Alors OK, on a peut-être une jolie sous-commande <code>git subtree push</code>, mais elle a l’inconvénient de <strong>backporter tous les commits qui ont touché le subtree</strong>&nbsp;:
 il n’est pas possible de choisir ceux qu’on veut.  Du coup, notre 
dernier commit, qui était de la personnalisation spécifique au 
conteneur, va partir aussi…  Grmbl.  Pas ce qu’on veut.  Je vous montre 
quand même&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
</pre></td><td class="code"><pre><code class="text"><span class="line"># Attention, ce n'est pas ce qu'on souhaite&nbsp;: ça backporte tout.  Pas le choix.
</span><span class="line">git-subtree/main (master u+4) $ git subtree push -P vendor/plugins/demo plugin master
</span><span class="line">git push using:  plugin master
</span><span class="line">-n 1/      10 (0)
</span><span class="line">-n 2/      10 (1)
</span><span class="line">-n 3/      10 (2)
</span><span class="line">-n 4/      10 (2)
</span><span class="line">-n 5/      10 (3)
</span><span class="line">-n 6/      10 (3)
</span><span class="line">-n 7/      10 (4)
</span><span class="line">-n 8/      10 (5)
</span><span class="line">-n 9/      10 (6)
</span><span class="line">-n 10/      10 (7)
</span><span class="line">Counting objects: 11, done.
</span><span class="line">Delta compression using up to 4 threads.
</span><span class="line">Compressing objects: 100% (9/9), done.
</span><span class="line">Writing objects: 100% (11/11), 1.11 KiB | 0 bytes/s, done.
</span><span class="line">Total 11 (delta 4), reused 0 (delta 0)
</span><span class="line">To ../remotes/plugin/
</span><span class="line">   2872e5d..e857a74  e857a74119c3e1c1b237b367c4a6c8f79deca1a7 -&gt; master
</span><span class="line">
</span><span class="line">git-subtree/main (master u+4) $ git log --oneline --decorate -4 plugin/master
</span><span class="line">e857a74 (plugin/master) MàJ du plugin uniquement dans le contexte courant
</span><span class="line">ddabc13 [To backport] Horodatage plugin (nécessite un ajustement conteneur)
</span><span class="line">73a22ea [To backport] Plugin plus rapide
</span><span class="line">2872e5d Pseudo-commit n°2
</span></code></pre></td></tr></tbody></table></div></figure>


<p>Vous remarquez le dernier backport (le plus en haut), qui n’aurait pas dû être là…</p>

<h4>Avec <code>git stree</code></h4>

<p>On peut faire les deux&nbsp;: si on fait un simple <code>push</code>, ça prend tout&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="text"><span class="line"># PAS CE QU'ON VEUT SUR CE COUP&nbsp;: ça prendrait tout.  Mais pratique sinon…
</span><span class="line">git-stree/main (master u+4) $ git stree push demo
</span><span class="line">…
</span></code></pre></td></tr></tbody></table></div></figure>


<p>Mais on peut naturellement préciser les commits&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">git-stree/main (master u+4) $ git stree push demo master~3 master^
</span><span class="line">• 5c24629 [To backport] Plugin plus rapide
</span><span class="line">• c57dbce [To backport] Horodatage plugin (nécessite un ajustement conteneur)
</span><span class="line">✔︎ STree 'demo' successfully backported local changes to its remote
</span><span class="line">
</span><span class="line">git-stree/main (master u+4) $
</span></code></pre></td></tr></tbody></table></div></figure>


<p>Alors, c’est pas mignon ça&nbsp;?  Ça nous a créé une branche dédiée au backport (en l’éspèce, <code>stree-backport-demo</code>), fait les cherry-picks nécessaires et le <code>push</code> qui va bien.</p>

<p><em>(Attention, à l’heure où j’écris ceci, évitez de référencer les commits à backporter en utilisant des syntaxes basées sur <code>HEAD</code>&nbsp;; je vais corriger ça rapidement.)</em></p>

<h3 id="retirer-un subtree">Retirer un subtree</h3>

<p>C’est juste un répertoire dans le dépôt.  Un bon vieux <code>git rm</code> fonctionne, comme d’habitude, et ce quelle que soit l’approche.</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">main (master u=) $ git rm -r vendor/plugins/demo
</span><span class="line">rm 'vendor/plugins/demo/README.md'
</span><span class="line">rm 'vendor/plugins/demo/fake-work'
</span><span class="line">rm 'vendor/plugins/demo/lib/index.js'
</span><span class="line">rm 'vendor/plugins/demo/plugin-config.json'
</span><span class="line">
</span><span class="line">main (master + u=) $ git commit -m "Retrait du subtree vendor/plugins/demo"
</span><span class="line">[master 3893865] Retrait du subtree vendor/plugins/demo
</span><span class="line"> 4 files changed, 24 deletions(-)
</span><span class="line"> delete mode 100644 vendor/plugins/demo/README.md
</span><span class="line"> delete mode 100644 vendor/plugins/demo/fake-work
</span><span class="line"> delete mode 100644 vendor/plugins/demo/lib/index.js
</span><span class="line"> delete mode 100644 vendor/plugins/demo/plugin-config.json
</span><span class="line">main (master u+1) $
</span></code></pre></td></tr></tbody></table></div></figure>


<h4>Avec <code>git stree</code></h4>

<p>Notez qu’il sera alors bon de virer la définition correspondante du subtree (configuration locale, dont le <em>remote</em>, et puis la branche de backport éventuelle), histoire de ne pas être à la rue, idéalement avant le commit final…</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">git-stree/main (master + u=) $ git stree rm demo
</span><span class="line">✔︎ All settings removed for STree 'demo'.
</span></code></pre></td></tr></tbody></table></div></figure>


<h3 id="transformer-un répertoire en subtree">Transformer un répertoire en subtree</h3>

<p>C’est le dernier cas fun&nbsp;: celui où le code était à la base une <strong>partie intégrante</strong> de notre dépôt, mais qu’on veut <strong>le sortir pour le partager</strong> entre plusieurs codebases.</p>

<p>Commençons par créer un dossier dans notre dépôt conteneur, et 
mélanger des commits le concernant et d’autres non.  On va reprendre le 
script utilisé plus haut, en changeant les dossiers.</p>

<p>Copiez-collez les commandes suivantes dans le dépôt «&nbsp;à la 
main&nbsp;» et, si vous avez joué avec, le dépôt «&nbsp;git 
subtree&nbsp;»&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">mkdir -p lib/plugins/myown/lib
</span><span class="line">echo '(function() { console.log("Yo"); })();' &gt; lib/plugins/myown/lib/index.js
</span><span class="line">git add lib/plugins/myown
</span><span class="line">git ci -m "Plugin sez: Yo, dawg."
</span><span class="line">date &gt;&gt; main-file-1
</span><span class="line">git ci -am "Boulot conteneur seul"
</span><span class="line">echo '// Now super fast' &gt; lib/plugins/myown/lib/index.js
</span><span class="line">date &gt;&gt; main-file-2
</span><span class="line">git ci -am "Plugin rapide (nécessite un ajustement conteneur)"
</span></code></pre></td></tr></tbody></table></div></figure>


<p>Ça devrait donc vous créer 3 commits, dont 2 touchent au dossier <code>lib/plugins/myown</code>.  Finissez avec un <code>git push</code> pour recaler le <em>remote</em>.</p>

<p>On va également se préparer un pseudo-<em>remote</em> qui servirait à accueillir ce nouveau subtree (à dupliquer si besoin dans la copie pour l’approche <code>git subtree</code>)&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">cd ..
</span><span class="line">mkdir remotes/myown
</span><span class="line">cd remotes/myown
</span><span class="line">git init --bare
</span><span class="line">cd ../../main
</span></code></pre></td></tr></tbody></table></div></figure>


<h4>À la main</h4>

<p>Le principe&nbsp;: on va créer une branche dédiée, et <strong>filtrer son historique pour ne garder que les commits concernant le sous-répertoire, en réécrivant l’arborescence au passage</strong>.</p>

<p>Ça a l’air bourrin comme ça, mais c’est en fait l’un des modes de la commande «&nbsp;bulldozer&nbsp;» <code>git filter-branch</code>.  Il s’agit du <code>--subdirectory-filter</code>.  Voyez plutôt&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">a-la-main/main (master u=) $ git checkout -b split-plugin
</span><span class="line">a-la-main/main (split-plugin) $ git filter-branch --subdirectory-filter lib/plugins/myown
</span><span class="line">Rewrite 973cfacecb645f66b89accedac8780c19140401b (2/2)
</span><span class="line">Ref 'refs/heads/split-plugin' was rewritten
</span><span class="line">
</span><span class="line">a-la-main/main (split-plugin) $ git log --oneline --decorate
</span><span class="line">5af0de1 (HEAD, split-plugin) Plugin rapide (nécessite un ajustement conteneur)
</span><span class="line">4fc711a Plugin sez: Yo, dawg.
</span><span class="line">
</span><span class="line">a-la-main/main (split-plugin) $ tree
</span><span class="line">.
</span><span class="line">└── lib
</span><span class="line">    └── index.js
</span><span class="line">
</span><span class="line">1 directory, 1 file
</span></code></pre></td></tr></tbody></table></div></figure>


<p><em>(Je rappelle que <code>tree</code> n’est pas forcément disponible sur votre système&nbsp;; s’il est manquant, faites juste un <code>ls -lR</code> à la place.)</em></p>

<p>On n’a plus qu’à transmettre ça au <em>remote</em> concerné&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">a-la-main/main (split-plugin) $ git remote add myown ../remotes/myown
</span><span class="line">a-la-main/main (split-plugin) $ git push -u myown split-plugin:master
</span><span class="line">Counting objects: 8, done.
</span><span class="line">Delta compression using up to 4 threads.
</span><span class="line">Compressing objects: 100% (2/2), done.
</span><span class="line">Writing objects: 100% (8/8), 617 bytes | 0 bytes/s, done.
</span><span class="line">Total 8 (delta 0), reused 0 (delta 0)
</span><span class="line">To ../remotes/myown
</span><span class="line"> * [new branch]      split-plugin -&gt; master
</span><span class="line">Branch split-plugin set up to track remote branch master from myown.
</span><span class="line">a-la-main/main (split-plugin u=) $
</span></code></pre></td></tr></tbody></table></div></figure>


<p>À ce stade, vous pouvez virer la branche si vous estimez ne plus en 
avoir besoin par la suite pour des backports.  Sinon, laissez-la, tant 
qu’à faire…</p>

<p>Inutile ensuite de remplacer le sous-répertoire dans <code>master</code> par un contenu obtenu via <code>read-tree</code>&nbsp;: de futurs <code>merge -s subtree --squash</code> marcheront sans souci, comme si vous l’aviez injecté depuis un subtree existant.  Pratique, non&nbsp;?</p>

<h4>Avec <code>git subtree</code></h4>

<p>Une sous-commande <code>split</code> existe pour faire à peu près la 
même chose.  En supposant que vous ayez fait les mêmes manip’s de 
préparation que sur la copie «&nbsp;à la main&nbsp;», ça donnerait 
ceci&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">git-subtree/main (master u=) $ git subtree split -P lib/plugins/myown -b split-plugin
</span><span class="line">-n 1/      14 (0)
</span><span class="line">-n 2/      14 (1)
</span><span class="line">-n 3/      14 (2)
</span><span class="line">-n 4/      14 (3)
</span><span class="line">-n 5/      14 (4)
</span><span class="line">-n 6/      14 (5)
</span><span class="line">-n 7/      14 (6)
</span><span class="line">-n 8/      14 (7)
</span><span class="line">-n 9/      14 (8)
</span><span class="line">-n 10/      14 (9)
</span><span class="line">-n 11/      14 (10)
</span><span class="line">-n 12/      14 (11)
</span><span class="line">-n 13/      14 (12)
</span><span class="line">-n 14/      14 (13)
</span><span class="line">Created branch 'split-plugin'
</span><span class="line">a54c695c65db858a68720dd9b93061ea28d13243
</span><span class="line">
</span><span class="line">git-subtree/main (master u=) $
</span></code></pre></td></tr></tbody></table></div></figure>


<p>Vous pouvez alors répéter les mêmes manip’s de création de remote et de <code>push</code> explicite que dans l’approche à la main&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">git-subtree/main (split-plugin) $ git remote add myown ../remotes/myown
</span><span class="line">git-subtree/main (split-plugin) $ git push -u myown split-plugin:master
</span><span class="line">Counting objects: 8, done.
</span><span class="line">Delta compression using up to 4 threads.
</span><span class="line">Compressing objects: 100% (2/2), done.
</span><span class="line">Writing objects: 100% (8/8), 556 bytes | 0 bytes/s, done.
</span><span class="line">Total 8 (delta 1), reused 0 (delta 0)
</span><span class="line">To ../remotes/myown
</span><span class="line"> * [new branch]      split-plugin -&gt; master
</span><span class="line">Branch split-plugin set up to track remote branch master from myown.
</span><span class="line">git-subtree/main (split-plugin u=) $
</span></code></pre></td></tr></tbody></table></div></figure>


<p>En revanche, <code>git subtree</code> refusera de faire des <code>pull</code> en mode <em>squash</em>
 par la suite, car il ne trouve pas trace d’un ajout précédent, dans la 
mesure où il ne se base pas sur les heuristiques de Git, mais sur sa 
propre implémentation technique des commits de fusion de subtree&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">git-subtree/main (split-plugin u=) $ git checkout master
</span><span class="line">git-subtree/main (master u=) $ git subtree pull --squash -P lib/plugins/myown myown master
</span><span class="line">From ../remotes/myown
</span><span class="line"> * branch            master     -&gt; FETCH_HEAD
</span><span class="line">Can't squash-merge: 'lib/plugins/myown' was never added.
</span></code></pre></td></tr></tbody></table></div></figure>


<p>En gros, soit vous oubliez les <em>squashes</em> et vous fusionnez 
l’historique du subtree à partir de maintenant (bleark&nbsp;!), soit 
vous remplacez le dossier historique par un ajout de subtree&nbsp;:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">git-subtree/main (master u=) $ git rm -r lib/plugins/myown
</span><span class="line">rm 'lib/plugins/myown/lib/index.js'
</span><span class="line">
</span><span class="line">git-subtree/main (master + u=) $ git commit -m "Retrait de lib/plugins/myown en prévision du subtree"
</span><span class="line">[master bf59e62] Retrait de lib/plugins/myown en prévision du subtree
</span><span class="line"> 1 file changed, 1 deletion(-)
</span><span class="line"> delete mode 100644 lib/plugins/myown/lib/index.js
</span><span class="line">
</span><span class="line">git-subtree/main (master u+1) $ git subtree add -P lib/plugins/myown --squash myown master
</span><span class="line">git fetch myown master
</span><span class="line">From ../remotes/myown
</span><span class="line"> * branch            master     -&gt; FETCH_HEAD
</span><span class="line">Added dir 'lib/plugins/myown'
</span><span class="line">
</span><span class="line">git-subtree/main (master u+3) $
</span></code></pre></td></tr></tbody></table></div></figure>


<p>À partir de quoi, les <code>git subtree pull -P lib/plugins/myown --squash myown master</code> marcheront…  Mais bon, ça en fait des cerceaux en flamme…</p>

<h4>Avec <code>git stree</code></h4>

<p>On n’a pas encore de commande dédiée pour ça&nbsp;; c’est prévu…</p>

<h3 id="autres-sous-commandes de git stree">Autres sous-commandes de <code>git stree</code></h3>

<p>Deux sous-commandes supplémentaires aident à la gestion des subtrees définis&nbsp;:</p>

<ul>
<li><code>list</code> affiche la liste des subtrees configurés&nbsp;; ajoutez l’option <code>-v</code> pour avoir tous les détails sur leur état.</li>
<li><code>forget</code> «&nbsp;oublie&nbsp;» toutes les configs&nbsp;; c’est juste une boucle de <code>git stree rm</code> sur tous les subtrees</li>
</ul>


<h2 id="alors-j’utilise quelle approche au final&nbsp;?">Alors, j’utilise quelle approche au final&nbsp;?</h2>

<p>L’important, c’est de <strong>bien comprendre l’approche à la main</strong>&nbsp;:
 elle vous permet de faire ce que vous voulez, selon vos choix 
stratégiques de gestion de branches, commits, backports, etc.</p>

<p>Pour la suite, je vous conseille plutôt <code>git stree</code>, mais avec vigilance à ce stade, car il n’est pas encore complètement blindé.  Ceci dit, il est bien pratique 😁</p>

<h2 id="envie-d’en savoir plus&nbsp;?">Envie d’en savoir plus&nbsp;?</h2>

<p>Notre formation <a href="http://www.git-attitude.fr/git-total/">Git Total</a>
 explore ces thématiques et bien d’autres pour vous donner une 
compréhension en profondeur de Git, vous transformant en experts en 
seulement 3 jours, pour un tarif très raisonnable&nbsp;!  Disponible en 
inter-entreprises tous les 2 mois (hors été) et en intra-entreprises <a href="http://www.git-attitude.fr/demander-une-intra-ou-custom">sur demande</a>.</p>
<div class="footnotes">
<hr>
<ol>
<li id="fn:1">
<p>Pour en savoir plus sur la découpe porcelaine/plomberie, <a href="http://git-scm.com/book/fr/v1/Les-tripes-de-Git-Plomberie-et-porcelaine">c’est par ici</a>…<a href="#fnref:1" rev="footnote">↩</a></p></li>
</ol>
</div>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Publié par <span class="fn">Christophe Porteneuve</span></span>

      








  


<time datetime="2015-01-30T00:00:00+01:00" pubdate="" data-updated="true">30 janvier 2015</time>
      

<span class="categories">
  
    <a class="category" href="http://www.git-attitude.fr/categories/didacticiels/">Didacticiels</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <iframe data-url="http://www.git-attitude.fr/2015/01/30/git-subtrees/" src="Comprendre%20et%20ma%C3%AEtriser%20les%20subtrees%20Git%20%E2%80%A2%20Git%20Attitude%C2%A0:%20formations%20Git%20qualitatives%20et%20sympathiques_fichiers/tweet_button.html" title="Twitter Tweet Button" style="position: static; visibility: visible; width: 70px; height: 20px;" class="twitter-share-button twitter-share-button-rendered twitter-tweet-button" allowtransparency="true" scrolling="no" id="twitter-widget-0" frameborder="0"></iframe>
  
  
  <div id="___plusone_0" style="text-indent: 0px; margin: 0px; padding: 0px; background: transparent none repeat scroll 0% 0%; border-style: none; float: none; line-height: normal; font-size: 1px; vertical-align: baseline; display: inline-block; width: 90px; height: 20px;"><iframe title="+1" data-gapiattached="true" src="Comprendre%20et%20ma%C3%AEtriser%20les%20subtrees%20Git%20%E2%80%A2%20Git%20Attitude%C2%A0:%20formations%20Git%20qualitatives%20et%20sympathiques_fichiers/fastbutton.html" name="I0_1460368359042" id="I0_1460368359042" vspace="0" tabindex="0" style="position: static; top: 0px; width: 90px; margin: 0px; border-style: none; left: 0px; visibility: visible; height: 20px;" scrolling="no" marginwidth="0" marginheight="0" hspace="0" width="100%" frameborder="0"></iframe></div>
  
  
    <div fb-iframe-plugin-query="app_id=212934732101925&amp;container_width=789&amp;href=http%3A%2F%2Fwww.git-attitude.fr%2F2015%2F01%2F30%2Fgit-subtrees%2F&amp;locale=fr_FR&amp;sdk=joey&amp;send=true&amp;show_faces=false&amp;width=450" fb-xfbml-state="rendered" class="fb-like fb_iframe_widget" data-send="true" data-width="450" data-show-faces="false"><span style="vertical-align: bottom; width: 450px; height: 20px;"><iframe class="" src="http://www.facebook.com/plugins/like.php?app_id=212934732101925&amp;channel=http%3A%2F%2Fstaticxx.facebook.com%2Fconnect%2Fxd_arbiter.php%3Fversion%3D42%23cb%3Df1a662adb0319c%26domain%3Dwww.git-attitude.fr%26origin%3Dhttp%253A%252F%252Fwww.git-attitude.fr%252Ff3cc334d8e64ebe%26relation%3Dparent.parent&amp;container_width=789&amp;href=http%3A%2F%2Fwww.git-attitude.fr%2F2015%2F01%2F30%2Fgit-subtrees%2F&amp;locale=fr_FR&amp;sdk=joey&amp;send=true&amp;show_faces=false&amp;width=450" style="border: medium none; visibility: visible; width: 450px; height: 20px;" title="fb:like Facebook Social Plugin" scrolling="no" allowfullscreen="true" allowtransparency="true" name="f10eb05e8f5fa0e" width="450px" frameborder="0" height="1000px"></iframe></span></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="http://www.git-attitude.fr/2015/01/12/bilan-2014/" title="Article précédent&nbsp;: 2014 est terminée, vive 2015&nbsp;!">« 2014 est terminée, vive 2015&nbsp;!</a>
      
      
        <a class="basic-alignment right" href="http://www.git-attitude.fr/2015/04/16/sessions-juin-juillet-2015/" title="Article suivant&nbsp;: Les sessions de juin et juillet sont arrivées&nbsp;!">Les sessions de juin et juillet sont arrivées&nbsp;! »</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Commentaires</h1>
    <div id="disqus_thread" aria-live="polite"><iframe verticalscrolling="no" horizontalscrolling="no" src="Comprendre%20et%20ma%C3%AEtriser%20les%20subtrees%20Git%20%E2%80%A2%20Git%20Attitude%C2%A0:%20formations%20Git%20qualitatives%20et%20sympathiques_fichiers/a.html" style="width: 1px ! important; min-width: 100% ! important; border: medium none ! important; overflow: hidden ! important; height: 1449px ! important;" title="Disqus" tabindex="0" scrolling="no" allowtransparency="true" name="dsq-app2" id="dsq-app2" width="100%" frameborder="0"></iframe></div>
  </section>

</div>

<aside class="sidebar thirds">
  
    <section class="first odd">
  <h1>Articles récents</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="http://www.git-attitude.fr/2016/01/28/bilan-2015/">2015 est terminée, vive 2016&nbsp;!</a>
      </li>
    
      <li class="post">
        <a href="http://www.git-attitude.fr/2016/01/27/sessions-t2-2016/">Les sessions du 2e trimestre 2016 sont arrivées&nbsp;!</a>
      </li>
    
      <li class="post">
        <a href="http://www.git-attitude.fr/2015/12/18/learning-github/">Notre cours vidéo GitHub est sorti&nbsp;!</a>
      </li>
    
      <li class="post">
        <a href="http://www.git-attitude.fr/2015/04/16/sessions-juin-juillet-2015/">Les sessions de juin et juillet sont arrivées&nbsp;!</a>
      </li>
    
      <li class="post">
        <a href="http://www.git-attitude.fr/2015/01/30/git-subtrees/">Comprendre et maîtriser les subtrees Git</a>
      </li>
    
  </ul>
</section>
<section class="even">
  <h1>Restez au courant&nbsp;!</h1>
  <!-- Begin MailChimp Signup Form -->
  <div style="margin-top: 1em;">
  <form action="http://delicious-insights.us5.list-manage.com/subscribe/post?u=c58a0a11f0bd6570e6ca66605&amp;id=2c1e1e675a" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate="">
    <p>
      <label for="mce-EMAIL">E-mail&nbsp;:</label>
      <input name="EMAIL" class="email" id="mce-EMAIL" placeholder="adresse@email.tld" required="" type="email">
      <input value="Et hop&nbsp;!" name="subscribe" id="mc-embedded-subscribe" class="button" type="submit">
      <small>(juste pour nous, de temps en temps)</small>
    </p>
  </form>
  </div>
  <!--End mc_embed_signup-->
</section><section class="odd">
  <h1>Prochaines sessions</h1>
  <p><small>(sauf mention contraire, il reste au moins 4 places)</small></p>
  <ul id="upcomingSessions" class="" data-dev="true"><li><a href="http://www.git-attitude.fr/git-total/">Git Total</a> <span class="dates">mercredi 11 mai 2016 • 3 jours</span> </li></ul><p><a href="http://www.git-attitude.fr/demander-une-convention/">Demander une convention de formation</a></p>
</section>
<section class="first even">
  <h1>Envie d’une formation sur mesure ou chez vous&nbsp;?</h1>
  <p>Vous avez une équipe d’une certaine taille et souhaitez organiser 
une session de formation directement auprès d’elle, dans vos 
locaux&nbsp;?</p>

<p>Vous aimeriez bénéficier d’une formation sur mesure, reprenant des 
parties de nos programmes existants et en explorant d’autres&nbsp;?</p>

<p>Vous souhaitez disposer d’une formation combinée recroisant les programmes de nos univers Git Attitude et JS Attitude&nbsp;?</p>

<p>Nous sommes à votre disposition pour élaborer avec vous un programme parfaitement adapté à vos besoins.</p>

<p><a href="http://www.git-attitude.fr/demander-une-intra-ou-custom">Contactez-nous pour tout nous dire&nbsp;!</a></p>
</section>
<section class="odd">
  <h1>Tweets récents</h1>
  <iframe data-widget-id="389419081465487361" style="position: static; visibility: visible; display: inline-block; width: 520px; height: 600px; padding: 0px; border: medium none; max-width: 100%; min-width: 180px; margin-top: 0px; margin-bottom: 0px; min-height: 200px;" class="twitter-timeline twitter-timeline-rendered" allowfullscreen="true" allowtransparency="true" scrolling="no" id="twitter-widget-1" frameborder="0"></iframe>
</section>




  
</aside>


    <span class="toggle-sidebar"></span></div>
  </div>
  <p id="logos">
  Ils nous font confiance&nbsp;:
  Kelkoo, MisterGoodDeal, PriceMinister, Blablacar / Comuto, Sarenza, 
Voyages-SNCF, LeMonde.fr, Fnac DIRECT, 20minutes, Orange, l’OCDE, Cisco,
 Alcatel-Lucent, Dassault Systèmes, EADS, Atos, Lagardère Interactive, 
Lesieur, L’Occitane en Provence, Météo France, 4D, Securitas, Digitas, 
Vivaki, Fullsix, Ekino, TBWA \ Paris, Valtech, Is Cool Entertainment, 
Open Wide…
</p>

  <footer role="contentinfo"><p>
  Copyright © 2010–2016 Christophe Porteneuve &amp; Delicious Insights •
  <span class="credit">Propulsé par l’extraordinaire <a href="http://octopress.org/">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'gitattitude';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.git-attitude.fr/2015/01/30/git-subtrees/';
        var disqus_url = 'http://www.git-attitude.fr/2015/01/30/git-subtrees/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div class=" fb_reset" id="fb-root"><div style="position: absolute; top: -10000px; height: 0px; width: 0px;"><div><iframe src="Comprendre%20et%20ma%C3%AEtriser%20les%20subtrees%20Git%20%E2%80%A2%20Git%20Attitude%C2%A0:%20formations%20Git%20qualitatives%20et%20sympathiques_fichiers/xd_arbiter.html" style="border: medium none;" tabindex="-1" title="Facebook Cross Domain Communication Frame" aria-hidden="true" id="fb_xdm_frame_http" scrolling="no" allowfullscreen="true" allowtransparency="true" name="fb_xdm_frame_http" frameborder="0"></iframe><iframe src="Comprendre%20et%20ma%C3%AEtriser%20les%20subtrees%20Git%20%E2%80%A2%20Git%20Attitude%C2%A0:%20formations%20Git%20qualitatives%20et%20sympathiques_fichiers/xd_arbiter_002.html" style="border: medium none;" tabindex="-1" title="Facebook Cross Domain Communication Frame" aria-hidden="true" id="fb_xdm_frame_https" scrolling="no" allowfullscreen="true" allowtransparency="true" name="fb_xdm_frame_https" frameborder="0"></iframe></div></div><div style="position: absolute; top: -10000px; height: 0px; width: 0px;"><div><iframe src="Comprendre%20et%20ma%C3%AEtriser%20les%20subtrees%20Git%20%E2%80%A2%20Git%20Attitude%C2%A0:%20formations%20Git%20qualitatives%20et%20sympathiques_fichiers/ping.html" style="display: none;" scrolling="no" allowfullscreen="true" allowtransparency="true" name="f24db4fdf4f901e" frameborder="0"></iframe></div></div></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/fr_FR/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    window.___gcfg = { lang: 'fr-FR' };
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



<script>!function(d,s,id){var 
js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>







<iframe tabindex="-1" style="width: 1px; height: 1px; position: absolute; top: -100px;" src="Comprendre%20et%20ma%C3%AEtriser%20les%20subtrees%20Git%20%E2%80%A2%20Git%20Attitude%C2%A0:%20formations%20Git%20qualitatives%20et%20sympathiques_fichiers/postmessageRelay.html" id="oauth2relay737345894" name="oauth2relay737345894"></iframe><iframe style="position: absolute; visibility: hidden; display: none; width: 0px; height: 0px; padding: 0px; border: medium none;" allowfullscreen="true" allowtransparency="true" scrolling="no" id="rufous-sandbox" frameborder="0"></iframe></body></html>